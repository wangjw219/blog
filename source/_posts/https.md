---
title: HTTPS 概述
date: 2019-07-02 00:20:15
tags:
- https
categories: [网络]
---
HTTPS（HyperText Transfer Protocol Secure）即超文本传输安全协议，常被成为 HTTP over SSL，是一种安全的网络通信协议。HTTPS 经由 HTTP 协议进行通信，通过 SSL/TLS 协议来加密数据包。
<!--more -->

### 为什么需要 HTTPS 协议？

因为 HTTP 通信并不安全：
- 通信使用明文（不加密），内容可能会被窃听
- 不验证通信方的身份，因此有可能遭遇伪装
- 无法验证报文的完整性，所以有可能已遭篡改

而 HTTPS 在 HTTP 的基础上添加了加密及认证机制，能够解决以上问题。

### HTTPS 是如何进行通信的？
HTTPS 协议中 HTTP 并不直接和 TCP 通信，而是先与 SSL/TLS 通信，数据经过 SSL/TLS 加密再发给 TCP。

基本分为握手阶段（SSL/TLS 协议建立）和通信阶段（HTTP 通信）。
握手阶段：客户端向服务端索要并验证公钥，然后双方协商生成"会话密钥"。
通信阶段：双方采用"会话密钥"进行加密通信。

**握手阶段详细步骤如下：**

![](https://ws1.sinaimg.cn/large/e250b5bdgy1g4r3dw33tnj20g40erwem.jpg)

第一步，客户端先向服务端发送加密通信的请求，这被叫做 ClientHello 请求，同时提供相关信息：
- 支持的协议版本，如 TLS 1.0 版本。
- 一个客户端生成的随机数，用于后面生成"会话密钥"。
- 支持的加密方法，例如 RSA 公钥加密。
- 支持的压缩方法。

第二步，服务端收到客户端的请求后，发出回应，这被叫做 ServerHello，同时提供相关信息：
- 确认使用的加密通信版本，如 TLS 1.0 版本；如果服务端和客户端支持的版本不一致，服务端会关闭加密通信。
- 一个服务端生成的随机数，用于后面生成"会话密钥"。
- 确认使用的加密方法，如 RSA 公钥加密。
- 服务器证书。

第三步，客户端验证服务端的证书，如果验证没问题，客户端就从服务端证书中提取服务端的公钥（公钥与证书绑定在一起），然后向服务端发送以下信息：
- 一个客户端生成随机数，用于后面生成"会话密钥"。该随机数用服务端的公钥进行加密。
- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 客户端结束通知，表示客户端的握手阶段结束。这一项同时也是前面发送的所有内容的 hash 值，用来供服务端校验。

第四步，服务端收到客户端通信后，再向客户端发送一下信息：
- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的 hash 值，用来供客户端校验。

**通信阶段：**
握手阶段完成后，客户端与服务端进入加密通信阶段，使用的是普通的 HTTP 协议，只不过通信内容通过"会话密钥"进行加密。

### HTTPS 如何解决 HTTP 的问题？
**1. 如何防止内容被窃听？**
对通信内容进行加密。使用的是对称密钥加密方法，密钥是通过握手阶段生成的三个随机数来生成的。

**2. 如何验证通信双方的身份？**
通过证书来认证。证书由客户端和服务端双方都可信赖的第三方结构颁发。

**3. 如何保证证书的有效性？**
接到证书的客户端可以使用证书认证机构的公开密钥对那张证书上的数字签名进行验证

证书的数字签名是服务端向认证机构申请证书时，认证机构使用自己的私有密钥签署的。

如何保证认证机构的公钥安全地发送给客户端？多数浏览器开发商发布版本时，会事先在内部植入常用认证机关的公开密钥。

**4. 如何验证报文的完整性？**
应用层发送数据时，会附加一种叫做 MAC（Message Authentication Code）的报文摘要。MAC 能够查出报文是否遭到篡改，从而保证报文的完整性。

**参考**
[SSL/TLS协议运行机制的概述][1]
[图解 HTTP][2]
[彻底搞懂HTTPS的加密机制][3]

[1]: http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html
[2]: https://www.amazon.cn/dp/B00JTQK1L4/ref=sr_1_1?ie=UTF8&qid=1513082876&sr=8-1&keywords=%E5%9B%BE%E8%A7%A3http
[3]: https://zhuanlan.zhihu.com/p/43789231